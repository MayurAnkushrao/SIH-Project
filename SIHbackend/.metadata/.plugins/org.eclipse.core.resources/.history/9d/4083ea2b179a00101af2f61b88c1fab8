package com.sih.SIHbackend.entity;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import org.hibernate.annotations.CreationTimestamp;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "sentiment_analysis")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class SentimentAnalysis {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "post_id", nullable = false)
    private Post post;  // Changed to entity relationship instead of postId
    
    @Column(name = "total_comments")
    private Integer totalComments = 0;
    
    @Column(name = "positive_count")
    private Integer positiveCount = 0;
    
    @Column(name = "negative_count")
    private Integer negativeCount = 0;
    
    @Column(name = "neutral_count")
    private Integer neutralCount = 0;
    
    @Column(name = "positive_percentage", precision = 5, scale = 2)
    private BigDecimal positivePercentage = BigDecimal.ZERO;
    
    @Column(name = "negative_percentage", precision = 5, scale = 2)
    private BigDecimal negativePercentage = BigDecimal.ZERO;
    
    @Column(name = "neutral_percentage", precision = 5, scale = 2)
    private BigDecimal neutralPercentage = BigDecimal.ZERO;
    
    @Lob
    private String summary;
    
    @Lob
    private String keywords;
    
    @CreationTimestamp
    @Column(name = "analyzed_at")
    private LocalDateTime analyzedAt;
    
    // Constructor with Post
    public SentimentAnalysis(Post post, Integer totalComments) {
        this.post = post;
        this.totalComments = totalComments;
        this.analyzedAt = LocalDateTime.now();
    }
    
    // Utility method to calculate percentages
    public void calculatePercentages() {
        if (totalComments > 0) {
            BigDecimal total = new BigDecimal(totalComments);
            this.positivePercentage = new BigDecimal(positiveCount)
                .multiply(new BigDecimal("100"))
                .divide(total, 2, BigDecimal.ROUND_HALF_UP);
            this.negativePercentage = new BigDecimal(negativeCount)
                .multiply(new BigDecimal("100"))
                .divide(total, 2, BigDecimal.ROUND_HALF_UP);
            this.neutralPercentage = new BigDecimal(neutralCount)
                .multiply(new BigDecimal("100"))
                .divide(total, 2, BigDecimal.ROUND_HALF_UP);
        }
    }
    
    // Convenience method to get post ID
    public Long getPostId() {
        return post != null ? post.getId() : null;
    }
}
